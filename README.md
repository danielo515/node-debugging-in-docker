# Node debugging in docker
#### Ejercicio para aprender a hacer debugging de aplicaciones node-js dentro de contenedores docker
#### Created by: Danielo Rodríguez Rivero
#### Keywords: rest,microservice, tutorial

# Lección 02 - debugging with VSCode

En esta lección se ha modificado la imagen de docker para utilizar la versión 8 de node, la cual incorpora mejoras en el rendimiento y souciona algunos problemas de seguridad que se encontraban en node 7.
Lamentablemente junto con el cambio de versión también vienen otros cambios. Tal y como anunciaba el mensaje de warning, la funcionalidad de `--inspect` ha cambiado ligeramente, y ya no nos proporciona una URL sencilla para copiar-pegar en nuestro navegador. 
No obstante, esto no es un problema ya que tenemos a nuestra disposición el debugger de VSCode, que es el que utilizaremos para conectar al debugger de forma remota.
En esta lección se incluye una configuración de VSCode para poder conectarse al contenedor, pero puede que no funcione correctamente. Es tarea del alumno solucionarlo de ser así.

* Debéis construir de nuevo la imagen de docker para que los cambios tengan efecto.
* Después podéis ejecutar el mismo comando que en la lección anterior para probar la nueva imagen.
* Si lo habéis hecho de forma correcta, deberíais ver en el log del contenedor que el debugger está a la escucha y deberíais poder conectar mediante el debugger de VSCode.

# Solución

El problema en este caso residía en la configuración de visual studio code. Faltaba la propiedad `remoteRoot`, la cual hemos omitido deshonestamente para generar un poco de diversión al lector.
El propósito de esta propiedad es indicarle a VSCode dónde se encuentran los archivos sobre los que estamos haciendo debugging en el equipo remoto.
Recordemos que, a efectos prácticos, cualquier contenedor de docker debe ser considerado como un equipo/ordenador/host distinto al nuestro.
VSCode sabe dónde están nuestros archivos, pero no tiene ni idea de como mapear lo que el debugger remoto le está reportando puesto que lo hará con el path en el sistema de archivos remoto.
Esta propiedad cambiará de una imagen a otra, y es necesario conocer bien cómo la imagen está construida y dónde se están emplazando dentro de la imagen.

Por ejemplo, en nuestro caso podemos referirnos a nuestros path local mediante la propiedad especial `${workspaceFolder}`, por lo que tendremos la configuración local de este modo:
`"localRoot": "${workspaceFolder}"`.
Para saber como configurar correctamente la propiedad `remoteRoot` debemos analizar la imagen de docker, en particular la siguientes líneas

```
ENV USER dockerfileUser
WORKDIR /home/$USER
```

Podemos ver que los archivos se están copiando en `/home/dockerfileUser`, por lo tanto esta es la información que le debemos dar a VSCode. 

Si te resulta más sencillo piensa que el debugger remoto le dirá a VSCode
> Hay un punto de interrupción en el archivo `/home/dockerfileUser/lib/index.js` en la línea 50

Entonces VSCode deberá ser capaz de traducir ese path a `${workspaceFolder}/lib/index.js` o probablemente a `/Users/home/username/repo-name/lib/index.js`.


## Commands reference

* `npm run build` en cualquiera de las ramas construye la imagen de docker
* `npm run docker-start` ejecuta el contenedor en modo interactivo (para poder ver los logs). Asegúrate de **construir la imagen primero!**
* `npm start` Start the server 
* `npm run start-dev` Start the server on dev mode 
* `npm test` Run tests 
* `git checkout master` para volver a las instrucciones básicas 
* `git checkout 01-basic-way` para ir a la primera lección
* `git checkout 02-debugging-with-vsc` para ir a la segunda lección
* `git checkout 03-bug-on-startup` para ir a la tercera lección
* `git checkout 04-configurable-debugging` para ir a la cuarta lección
* `git checkout 05-already-running-container` para ir a la quinta lección
* With the server running, open `http://localhost:3000/version` to see the version of your package
* With the server running, open `http://localhost:3000/documentation` to see the documentation of your API

The example microservice that is used for exploring the different scenarios was generated by the [Hapi Swagger ES6 Generator](https://github.com/danielo515/generator-hapi-swagger-es6)
